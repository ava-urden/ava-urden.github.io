<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NASA APOD – Astronomy Picture of the Day</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
      h1 { margin: 0 0 6px; }
      .muted { color: #666; }
      .error { color: #b00020; }
      .ok { color: #0b6b2a; }
      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      input, button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; }
      input { min-width: 260px; }
      button { background: #fff; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .card { margin-top: 14px; border: 1px solid #ddd; border-radius: 14px; padding: 14px; display: none; }
      img { max-width: 100%; border-radius: 14px; border: 1px solid #eee; }
      iframe { width: 100%; height: 520px; border-radius: 14px; border: 1px solid #eee; }
      .meta { margin-top: 6px; }
      .meta span { display: inline-block; margin-right: 10px; }
      .toolbar { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
      .small { font-size: 14px; }
      a { color: inherit; }
    </style>
  </head>

  <body>
    <h1>NASA – Astronomy Picture of the Day</h1>
    <p class="muted small">
      Lägg in din NASA API key (sparas i webbläsaren). Välj datum (valfritt) och klicka “Hämta”.
    </p>

    <section class="row" style="margin: 12px 0;">
      <input id="keyInput" placeholder="Klistra in NASA API key här" />
      <button id="saveKeyBtn">Spara nyckel</button>
      <button id="clearKeyBtn">Rensa</button>
      <span id="keyStatus" class="muted"></span>
    </section>

    <section class="row">
      <input id="dateInput" type="date" />
      <button id="fetchBtn">Hämta APOD</button>
      <button id="randomBtn" title="Hämtar 5 slumpbilder">Slumpa 5</button>
      <span id="status" class="muted">Redo.</span>
    </section>

    <div id="card" class="card">
      <h2 id="title"></h2>

      <div class="meta muted small">
        <span><strong>Datum:</strong> <span id="date"></span></span>
        <span><strong>Typ:</strong> <span id="mediaType"></span></span>
        <span id="copyrightWrap" style="display:none;"><strong>Copyright:</strong> <span id="copyright"></span></span>
      </div>

      <div id="mediaWrap" style="margin-top: 12px;">
        <img id="img" alt="" style="display:none;" />
        <iframe id="video" style="display:none;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>

      <div class="toolbar">
        <button id="openBtn" type="button">Öppna media</button>
        <button id="copyBtn" type="button">Kopiera media-länk</button>
      </div>

      <p id="explanation" style="margin-top: 12px;"></p>
    </div>

    <hr style="margin: 18px 0; border: none; border-top: 1px solid #eee;" />

    <div id="gallery" class="card" style="display:none;">
      <h2>Slumpade APOD (5 st)</h2>
      <p class="muted small">Klicka på ett kort för att öppna det.</p>
      <div id="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;"></div>
    </div>

    <script>
      const STORAGE_KEY = "nasa_apod_key";

      const keyInput = document.getElementById("keyInput");
      const saveKeyBtn = document.getElementById("saveKeyBtn");
      const clearKeyBtn = document.getElementById("clearKeyBtn");
      const keyStatus = document.getElementById("keyStatus");

      const dateInput = document.getElementById("dateInput");
      const fetchBtn = document.getElementById("fetchBtn");
      const randomBtn = document.getElementById("randomBtn");
      const statusEl = document.getElementById("status");

      const card = document.getElementById("card");
      const titleEl = document.getElementById("title");
      const dateEl = document.getElementById("date");
      const mediaTypeEl = document.getElementById("mediaType");
      const copyrightWrap = document.getElementById("copyrightWrap");
      const copyrightEl = document.getElementById("copyright");
      const explanationEl = document.getElementById("explanation");

      const imgEl = document.getElementById("img");
      const videoEl = document.getElementById("video");

      const openBtn = document.getElementById("openBtn");
      const copyBtn = document.getElementById("copyBtn");

      const gallery = document.getElementById("gallery");
      const grid = document.getElementById("grid");

      function setStatus(text, type = "muted") {
        statusEl.className = type;
        statusEl.textContent = text;
      }

      function setKeyStatus(text, type = "muted") {
        keyStatus.className = type;
        keyStatus.textContent = text;
      }

      function getKey() {
        return localStorage.getItem(STORAGE_KEY) || "";
      }

      function saveKey(k) {
        localStorage.setItem(STORAGE_KEY, k);
      }

      function clearKey() {
        localStorage.removeItem(STORAGE_KEY);
      }

      async function fetchJSON(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) {
          let msg = `HTTP ${res.status}`;
          try {
            const err = await res.json();
            if (err && err.msg) msg += ` – ${err.msg}`;
            if (err && err.error && err.error.message) msg += ` – ${err.error.message}`;
          } catch {}
          throw new Error(msg);
        }
        return res.json();
      }

      // APOD video-länkar kan ibland vara "watch?v="; gör dem mer iframe-vänliga när det går.
      function toEmbeddableUrl(url) {
        try {
          const u = new URL(url);
          // YouTube
          if (u.hostname.includes("youtube.com") && u.searchParams.get("v")) {
            return `https://www.youtube.com/embed/${u.searchParams.get("v")}`;
          }
          if (u.hostname === "youtu.be") {
            return `https://www.youtube.com/embed/${u.pathname.replace("/", "")}`;
          }
          // Vimeo
          if (u.hostname.includes("vimeo.com")) {
            const id = u.pathname.split("/").filter(Boolean)[0];
            if (id) return `https://player.vimeo.com/video/${id}`;
          }
          return url;
        } catch {
          return url;
        }
      }

      function buildApodUrl(paramsObj) {
        const key = getKey();
        if (!key) throw new Error("Ingen API-nyckel sparad. Klistra in och spara din NASA key först.");

        const base = "https://api.nasa.gov/planetary/apod";
        const params = new URLSearchParams();
        params.set("api_key", key);
        params.set("thumbs", "true"); // hjälper vid video (thumbnail_url)

        for (const [k, v] of Object.entries(paramsObj || {})) {
          if (v !== undefined && v !== null && v !== "") params.set(k, String(v));
        }
        return `${base}?${params.toString()}`;
      }

      function resetSingleView() {
        card.style.display = "none";
        imgEl.style.display = "none";
        imgEl.removeAttribute("src");
        videoEl.style.display = "none";
        videoEl.removeAttribute("src");
        openBtn.onclick = null;
        copyBtn.onclick = null;
      }

      function renderSingle(data) {
        gallery.style.display = "none"; // stäng galleri om det var öppet
        resetSingleView();

        titleEl.textContent = data.title || "Untitled";
        dateEl.textContent = data.date || "—";
        mediaTypeEl.textContent = data.media_type || "—";
        explanationEl.textContent = data.explanation || "";

        if (data.copyright) {
          copyrightEl.textContent = data.copyright;
          copyrightWrap.style.display = "inline-block";
        } else {
          copyrightWrap.style.display = "none";
        }

        const mediaUrl = data.hdurl || data.url || "";
        const openUrl = data.url || mediaUrl;

        if (data.media_type === "image") {
          imgEl.src = mediaUrl;
          imgEl.alt = data.title || "APOD image";
          imgEl.style.display = "block";
        } else if (data.media_type === "video") {
          const embed = toEmbeddableUrl(data.url);
          videoEl.src = embed;
          videoEl.style.display = "block";
        } else {
          explanationEl.textContent += "\n\nKunde inte visa media. URL: " + (data.url || "—");
        }

        openBtn.onclick = () => {
          if (openUrl) window.open(openUrl, "_blank", "noopener,noreferrer");
        };

        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(openUrl);
            setStatus("Länken är kopierad ✓", "ok");
          } catch {
            setStatus("Kunde inte kopiera (saknar behörighet).", "error");
          }
        };

        card.style.display = "block";
      }

      function renderGallery(items) {
        resetSingleView();
        grid.innerHTML = "";

        for (const item of items) {
          const div = document.createElement("div");
          div.style.border = "1px solid #ddd";
          div.style.borderRadius = "14px";
          div.style.padding = "12px";
          div.style.cursor = "pointer";

          const title = document.createElement("div");
          title.innerHTML = `<strong>${item.title || "Untitled"}</strong>`;
          const meta = document.createElement("div");
          meta.className = "muted small";
          meta.textContent = `${item.date || "—"} • ${item.media_type || "—"}`;

          const preview = document.createElement("img");
          preview.style.marginTop = "10px";
          preview.style.display = "block";
          preview.alt = item.title || "APOD preview";
          preview.loading = "lazy";

          // För video: använd thumbnail_url om den finns, annars ingen preview.
          if (item.media_type === "image") {
            preview.src = item.url;
            div.appendChild(preview);
          } else if (item.media_type === "video" && item.thumbnail_url) {
            preview.src = item.thumbnail_url;
            div.appendChild(preview);
          }

          div.appendChild(title);
          div.appendChild(meta);

          div.addEventListener("click", () => renderSingle(item));
          grid.appendChild(div);
        }

        gallery.style.display = "block";
        setStatus("Klart ✓", "ok");
      }

      async function loadSingle(dateStr) {
        setStatus("Hämtar APOD…");
        fetchBtn.disabled = true;
        randomBtn.disabled = true;

        try {
          const url = buildApodUrl({ date: dateStr || "" });
          const data = await fetchJSON(url);
          renderSingle(data);
          setStatus("Klart ✓", "ok");
        } catch (e) {
          setStatus("Fel: " + e.message, "error");
        } finally {
          fetchBtn.disabled = false;
          randomBtn.disabled = false;
        }
      }

      async function loadRandomFive() {
        setStatus("Hämtar 5 slumpbilder…");
        fetchBtn.disabled = true;
        randomBtn.disabled = true;

        try {
          const url = buildApodUrl({ count: 5 });
          const data = await fetchJSON(url);
          if (!Array.isArray(data)) throw new Error("Förväntade en lista (array) från API.");
          renderGallery(data);
        } catch (e) {
          setStatus("Fel: " + e.message, "error");
        } finally {
          fetchBtn.disabled = false;
          randomBtn.disabled = false;
        }
      }

      // Init – ladda ev sparad nyckel i input
      const existingKey = getKey();
      if (existingKey) {
        keyInput.value = existingKey;
        setKeyStatus("Nyckel finns sparad.", "ok");
      } else {
        setKeyStatus("Ingen nyckel sparad än.", "muted");
      }

      saveKeyBtn.addEventListener("click", () => {
        const k = keyInput.value.trim();
        if (!k) return setKeyStatus("Klistra in en nyckel först.", "error");
        saveKey(k);
        setKeyStatus("Sparad ✓", "ok");
      });

      clearKeyBtn.addEventListener("click", () => {
        clearKey();
        keyInput.value = "";
        setKeyStatus("Rensad.", "muted");
      });

      fetchBtn.addEventListener("click", () => loadSingle(dateInput.value));
      randomBtn.addEventListener("click", () => loadRandomFive());

      // Liten bonus: hämta dagens APOD direkt när du har key (om du vill)
      // loadSingle("");
    </script>
  </body>
</html>
